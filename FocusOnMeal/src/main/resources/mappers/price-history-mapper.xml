<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fom.boot.domain.ingredient.model.mapper.IngredientPriceHistoryMapper">

  	<!-- PriceHistory resultMap -->
  	<resultMap id="PriceHistory" type="com.fom.boot.domain.ingredient.model.vo.PriceHistory">
  		<id			property="priceHistoryId"	column="PRICE_HISTORY_ID" 	/>
  		<result 	property="ingredientId"		column="INGREDIENT_ID"	 	/>
  		<result 	property="priceValue"		column="PRICE_VALUE"		/>
  		<result		property="priceType"		column="PRICE_TYPE"			/>
  		<result		property="region"			column="REGION"				/>
  		<result		property="collectedDate"	column="COLLECTED_DATE"		/>
  	</resultMap>

  	<!-- 특정 식자재의 최근 가격 조회 (1개) -->
  	<select id="getRecentPriceByName" resultMap="PriceHistory">
  		SELECT ph.*
  		FROM PRICE_HISTORY ph
  		JOIN INGREDIENT_MASTER i ON ph.INGREDIENT_ID = i.INGREDIENT_ID
  		WHERE i.NAME LIKE '%' || #{ingredientName} || '%'
  		ORDER BY ph.COLLECTED_DATE DESC
  		FETCH FIRST 1 ROWS ONLY
  	</select>

  	<!-- 특정 식자재의 최근 가격 이력 조회 (여러 개) -->
  	<select id="getRecentPricesByName" resultMap="PriceHistory">
  		SELECT ph.*
  		FROM PRICE_HISTORY ph
  		JOIN INGREDIENT_MASTER i ON ph.INGREDIENT_ID = i.INGREDIENT_ID
  		WHERE i.NAME LIKE '%' || #{ingredientName} || '%'
  		ORDER BY ph.COLLECTED_DATE DESC
  		FETCH FIRST #{limit} ROWS ONLY
  	</select>

  	<!-- 가격 정보 저장 -->
    <insert id="insertPrice" parameterType="com.fom.boot.domain.ingredient.model.vo.PriceHistory">
        <!-- 오라클 시퀀스를 사용한 자동 번호 생성 -->
        <selectKey keyProperty="priceHistoryId" resultType="int" order="BEFORE">
            SELECT SEQ_PRICE_HISTORY.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO PRICE_HISTORY (
            PRICE_HISTORY_ID,
            INGREDIENT_ID,
            PRICE_VALUE,
            PRICE_TYPE,
            REGION,
            COLLECTED_DATE
        ) VALUES (
            #{priceHistoryId},
            #{ingredientId},
            #{priceValue},
            #{priceType},
            #{region},
            #{collectedDate}
        )
    </insert>

    <!-- 특정 식자재의 모든 가격 이력 조회 -->
    <select id="getPriceHistoryByIngredientId" resultMap="PriceHistory">
    	SELECT *
    	FROM PRICE_HISTORY
    	WHERE INGREDIENT_ID = #{ingredientId}
    	ORDER BY COLLECTED_DATE DESC
    </select>

    <!-- 특정 식자재의 오늘 가격이 이미 저장되어 있는지 확인 -->
    <select id="checkTodayPriceExists" resultType="int">
        SELECT COUNT(*)
        FROM PRICE_HISTORY
        WHERE INGREDIENT_ID = #{ingredientId}
        AND TRUNC(COLLECTED_DATE) = TRUNC(SYSDATE)
    </select>
    
        <!-- 특정 날짜 범위에서 가장 최근 가격 조회 -->
    <select id="findLatestPriceByIngredientAndDateRange" resultMap="PriceHistory">
        SELECT *
        FROM (
            SELECT *
            FROM PRICE_HISTORY
            WHERE INGREDIENT_ID = #{ingredientId}
              AND COLLECTED_DATE &gt;= #{startDate}
              AND COLLECTED_DATE &lt; #{endDate}
              AND REGION = '서울'
              AND PRICE_TYPE = '소매'
            ORDER BY COLLECTED_DATE DESC
        )
        WHERE ROWNUM = 1
    </select>

	<!-- 날짜 범위로 가격 이력 조회 -->
    <select id="selectByDateRange" resultMap="PriceHistory" parameterType="map">
        SELECT 
            PRICE_HISTORY_ID,
            INGREDIENT_ID,
            PRICE_VALUE,
            PRICE_TYPE,
            REGION,
            COLLECTED_DATE
        FROM PRICE_HISTORY
        WHERE INGREDIENT_ID = #{ingredientId}
          AND COLLECTED_DATE BETWEEN #{startDate} AND #{endDate}
        <if test="priceType != null and priceType != ''">
            AND PRICE_TYPE = #{priceType}
        </if>
        <if test="region != null and region != ''">
            AND REGION = #{region}
        </if>
        ORDER BY COLLECTED_DATE ASC
    </select>
    
    <!-- 최신 가격 조회 -->
    <select id="selectLatestPrice" resultMap="PriceHistory" parameterType="map">
        SELECT 
            PRICE_HISTORY_ID,
            INGREDIENT_ID,
            PRICE_VALUE,
            PRICE_TYPE,
            REGION,
            COLLECTED_DATE
        FROM (
            SELECT *
            FROM PRICE_HISTORY
            WHERE INGREDIENT_ID = #{ingredientId}
            <if test="priceType != null and priceType != ''">
                AND PRICE_TYPE = #{priceType}
            </if>
            <if test="region != null and region != ''">
                AND REGION = #{region}
            </if>
            ORDER BY COLLECTED_DATE DESC
        )
        WHERE ROWNUM = 1
    </select>
    
    <!-- 특정 날짜에 가장 가까운 가격 조회 -->
    <select id="selectClosestPrice" resultMap="PriceHistory" parameterType="map">
        SELECT *
        FROM (
            SELECT 
                PRICE_HISTORY_ID,
                INGREDIENT_ID,
                PRICE_VALUE,
                PRICE_TYPE,
                REGION,
                COLLECTED_DATE,
                ABS(EXTRACT(DAY FROM (COLLECTED_DATE - #{targetDate}))) AS date_diff
            FROM PRICE_HISTORY
            WHERE INGREDIENT_ID = #{ingredientId}
            <if test="priceType != null and priceType != ''">
                AND PRICE_TYPE = #{priceType}
            </if>
            <if test="region != null and region != ''">
                AND REGION = #{region}
            </if>
            ORDER BY date_diff ASC, COLLECTED_DATE DESC
        )
        WHERE ROWNUM = 1
    </select>
</mapper>
