<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.safety.model.mapper.SafetyMapper">
  
  	<!-- ResultMap 정의 -->
    <resultMap id="safetyAlertResultMap" type="com.fom.boot.domain.alert.model.vo.SafetyAlert">
        <id property="alertId" column="ALERT_ID" />
        <result property="ingredientId" column="INGREDIENT_ID" />
        <result property="nation" column="NATION" />
        <result property="hazardType" column="HAZARD_TYPE" />
        <result property="title" column="TITLE" />
        <result property="description" column="DESCRIPTION" />
        <result property="publicationDate" column="PUBLICATION_DATE" />
    </resultMap>

    <!-- 검색 조건 SQL 조각 -->
    <sql id="searchCondition">
        <where>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="type.equals('title')">
			            TITLE LIKE '%' || #{keyword} || '%'
			        </when>
			        <when test="type.equals('nation')">
			            NATION LIKE '%' || #{keyword} || '%'
			        </when>
			        <when test="type.equals('hazardType')">
			            HAZARD_TYPE LIKE '%' || #{keyword} || '%'
			        </when>
                    <otherwise>
                        (
                            TITLE LIKE '%' || #{keyword} || '%'
                            OR NATION LIKE '%' || #{keyword} || '%'
                            OR HAZARD_TYPE LIKE '%' || #{keyword} || '%'
                        )
                    </otherwise>
                </choose>
            </if>
            <!-- 국가 초성 필터 -->
            <if test="nationFilter != null and nationFilter != ''">
                <choose>
                    <when test="nationFilter.equals('ㄱ')"> 
			            AND (NATION LIKE '가%' OR NATION LIKE '갸%' OR NATION LIKE '거%' OR NATION LIKE '겨%' 
			            OR NATION LIKE '고%' OR NATION LIKE '교%' OR NATION LIKE '구%' OR NATION LIKE '규%' 
			            OR NATION LIKE '그%' OR NATION LIKE '기%')
			        </when>
                    <when test="nationFilter.equals('ㄴ')"> 
                        AND (NATION LIKE '나%' OR NATION LIKE '냐%' OR NATION LIKE '너%' OR NATION LIKE '녀%' 
                        OR NATION LIKE '노%' OR NATION LIKE '뇨%' OR NATION LIKE '누%' OR NATION LIKE '뉴%' 
                        OR NATION LIKE '느%' OR NATION LIKE '니%')
                    </when>
                    <when test="nationFilter.equals('ㄷ')"> 
                        AND (NATION LIKE '다%' OR NATION LIKE '댜%' OR NATION LIKE '더%' OR NATION LIKE '뎌%' 
                        OR NATION LIKE '도%' OR NATION LIKE '됴%' OR NATION LIKE '두%' OR NATION LIKE '듀%' 
                        OR NATION LIKE '드%' OR NATION LIKE '디%')
                    </when>
                    <when test="nationFilter.equals('ㄹ')"> 
                        AND (NATION LIKE '라%' OR NATION LIKE '랴%' OR NATION LIKE '러%' OR NATION LIKE '려%' 
                        OR NATION LIKE '로%' OR NATION LIKE '료%' OR NATION LIKE '루%' OR NATION LIKE '류%' 
                        OR NATION LIKE '르%' OR NATION LIKE '리%')
                    </when>
                    <when test="nationFilter.equals('ㅁ')"> 
                        AND (NATION LIKE '마%' OR NATION LIKE '먀%' OR NATION LIKE '머%' OR NATION LIKE '며%' 
                        OR NATION LIKE '모%' OR NATION LIKE '묘%' OR NATION LIKE '무%' OR NATION LIKE '뮤%' 
                        OR NATION LIKE '므%' OR NATION LIKE '미%')
                    </when>
                    <when test="nationFilter.equals('ㅂ')"> 
                        AND (NATION LIKE '바%' OR NATION LIKE '뱌%' OR NATION LIKE '버%' OR NATION LIKE '벼%' 
                        OR NATION LIKE '보%' OR NATION LIKE '뵤%' OR NATION LIKE '부%' OR NATION LIKE '뷰%' 
                        OR NATION LIKE '브%' OR NATION LIKE '비%')
                    </when>
                    <when test="nationFilter.equals('ㅅ')"> 
                        AND (NATION LIKE '사%' OR NATION LIKE '샤%' OR NATION LIKE '서%' OR NATION LIKE '셔%' 
                        OR NATION LIKE '소%' OR NATION LIKE '쇼%' OR NATION LIKE '수%' OR NATION LIKE '슈%' 
                        OR NATION LIKE '스%' OR NATION LIKE '시%')
                    </when>
                    <when test="nationFilter.equals('ㅇ')"> 
                        AND (NATION LIKE '아%' OR NATION LIKE '야%' OR NATION LIKE '어%' OR NATION LIKE '여%' 
                        OR NATION LIKE '오%' OR NATION LIKE '요%' OR NATION LIKE '우%' OR NATION LIKE '유%' 
                        OR NATION LIKE '으%' OR NATION LIKE '이%')
                    </when>
                    <when test="nationFilter.equals('ㅈ')"> 
                        AND (NATION LIKE '자%' OR NATION LIKE '쟈%' OR NATION LIKE '저%' OR NATION LIKE '져%' 
                        OR NATION LIKE '조%' OR NATION LIKE '죠%' OR NATION LIKE '주%' OR NATION LIKE '쥬%' 
                        OR NATION LIKE '즈%' OR NATION LIKE '지%')
                    </when>
                    <when test="nationFilter.equals('ㅊ')"> 
                        AND (NATION LIKE '차%' OR NATION LIKE '챠%' OR NATION LIKE '처%' OR NATION LIKE '쳐%' 
                        OR NATION LIKE '초%' OR NATION LIKE '쵸%' OR NATION LIKE '추%' OR NATION LIKE '츄%' 
                        OR NATION LIKE '츠%' OR NATION LIKE '치%')
                    </when>
                    <when test="nationFilter.equals('ㅋ')"> 
                        AND (NATION LIKE '카%' OR NATION LIKE '캬%' OR NATION LIKE '커%' OR NATION LIKE '켜%' 
                        OR NATION LIKE '코%' OR NATION LIKE '쿄%' OR NATION LIKE '쿠%' OR NATION LIKE '큐%' 
                        OR NATION LIKE '크%' OR NATION LIKE '키%')
                    </when>
                    <when test="nationFilter.equals('ㅌ')"> 
                        AND (NATION LIKE '타%' OR NATION LIKE '탸%' OR NATION LIKE '터%' OR NATION LIKE '텨%' 
                        OR NATION LIKE '토%' OR NATION LIKE '툐%' OR NATION LIKE '투%' OR NATION LIKE '튜%' 
                        OR NATION LIKE '트%' OR NATION LIKE '티%')
                    </when>
                    <when test="nationFilter.equals('ㅍ')"> 
                        AND (NATION LIKE '파%' OR NATION LIKE '퍄%' OR NATION LIKE '퍼%' OR NATION LIKE '펴%' 
                        OR NATION LIKE '포%' OR NATION LIKE '표%' OR NATION LIKE '푸%' OR NATION LIKE '퓨%' 
                        OR NATION LIKE '프%' OR NATION LIKE '피%')
                    </when>
                    <when test="nationFilter.equals('ㅎ')"> 
                        AND (NATION LIKE '하%' OR NATION LIKE '햐%' OR NATION LIKE '허%' OR NATION LIKE '혀%' 
                        OR NATION LIKE '호%' OR NATION LIKE '효%' OR NATION LIKE '후%' OR NATION LIKE '휴%' 
                        OR NATION LIKE '흐%' OR NATION LIKE '히%')
                    </when>
                </choose>
            </if>
            <!-- 위험 유형 필터 -->
            <if test="hazardFilter != null and hazardFilter != ''">
                AND HAZARD_TYPE = #{hazardFilter}
            </if>
        </where>
    </sql>

    <!-- 정렬 조건 SQL 조각 -->
    <sql id="orderByCondition">
        ORDER BY 
            <choose>
                <when test="sortColumn == 'nation'">
                    NATION
                </when>
                <when test="sortColumn == 'hazardType'">
                    HAZARD_TYPE
                </when>
                <when test="sortColumn == 'title'">
                    TITLE
                </when>
                <when test="sortColumn == 'publicationDate'">
                    PUBLICATION_DATE
                </when>
                <otherwise>
                    ALERT_ID
                </otherwise>
            </choose>
            <choose>
                <when test="sortOrder == 'asc'">
                    ASC
                </when>
                <otherwise>
                    DESC
                </otherwise>
            </choose>
    </sql>

    <!-- 안전 정보 개수 조회 -->
    <select id="selectAlertListCount" resultType="int">
        SELECT COUNT(*)
        FROM SAFETY_ALERT_MASTER
        <include refid="searchCondition" />
    </select>

    <!-- 안전 정보 목록 조회 (Oracle 페이징 처리) -->
    <select id="selectAlertList" resultMap="safetyAlertResultMap">
    SELECT *
    FROM (
        SELECT 
            ROWNUM AS RNUM,
            A.*
        FROM (
            SELECT 
                ALERT_ID,
                INGREDIENT_ID,
                NATION,
                HAZARD_TYPE,
                TITLE,
                DESCRIPTION,
                PUBLICATION_DATE
            FROM SAFETY_ALERT_MASTER
            <include refid="searchCondition" />
            <include refid="orderByCondition" />
        ) A
    )
    WHERE RNUM BETWEEN 
        #{startRow, jdbcType=NUMERIC}  AND 
        #{endRow, jdbcType=NUMERIC}    
    </select>

    <!-- 안전 정보 상세 조회 -->
    <select id="selectAlertDetail" resultMap="safetyAlertResultMap">
        SELECT 
            ALERT_ID,
            INGREDIENT_ID,
            NATION,
            HAZARD_TYPE,
            TITLE,
            DESCRIPTION,
            PUBLICATION_DATE
        FROM SAFETY_ALERT_MASTER
        WHERE ALERT_ID = #{alertId}
    </select>

    <!-- 이전 글 조회 -->
    <select id="selectPrevAlert" resultMap="safetyAlertResultMap">
        SELECT 
            ALERT_ID,
            TITLE
        FROM SAFETY_ALERT_MASTER
        WHERE ALERT_ID &lt; #{alertId}
        ORDER BY ALERT_ID DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 다음 글 조회 -->
    <select id="selectNextAlert" resultMap="safetyAlertResultMap">
        SELECT 
            ALERT_ID,
            TITLE
        FROM SAFETY_ALERT_MASTER
        WHERE ALERT_ID &gt; #{alertId}
        ORDER BY ALERT_ID ASC
        FETCH FIRST 1 ROWS ONLY
    </select>
    
    <!-- 상세페이지 이전 글 조회 -->
	<select id="getPreviousAlert" resultType="com.fom.boot.domain.alert.model.vo.SafetyAlert">
	    SELECT 
	        ALERT_ID AS alertId,
	        TITLE AS title,
	        PUBLICATION_DATE AS publicationDate
	    FROM (
	        SELECT 
	            ALERT_ID,
	            TITLE,
	            PUBLICATION_DATE
	        FROM SAFETY_ALERT_MASTER
	        WHERE ALERT_ID <![CDATA[<]]> #{alertId}
	        ORDER BY ALERT_ID DESC
	    )
	    WHERE ROWNUM = 1
	</select>
	
	<!-- 상세페이지 다음 글 조회 -->
	<select id="getNextAlert" resultType="com.fom.boot.domain.alert.model.vo.SafetyAlert">
	    SELECT 
	        ALERT_ID AS alertId,
	        TITLE AS title,
	        PUBLICATION_DATE AS publicationDate
	    FROM (
	        SELECT 
	            ALERT_ID,
	            TITLE,
	            PUBLICATION_DATE
	        FROM SAFETY_ALERT_MASTER
	        WHERE ALERT_ID <![CDATA[>]]> #{alertId}
	        ORDER BY ALERT_ID ASC
	    )
	    WHERE ROWNUM = 1
	</select>
	
	<!-- 안전 정보 등록 -->
    <insert id="insertAlert">
        <selectKey keyProperty="alertId" resultType="int" order="BEFORE">
            SELECT NVL(MAX(ALERT_ID), 0) + 1 FROM SAFETY_ALERT_MASTER
        </selectKey>
        INSERT INTO SAFETY_ALERT_MASTER (
            ALERT_ID,
            INGREDIENT_ID,
            NATION,
            HAZARD_TYPE,
            TITLE,
            DESCRIPTION,
            PUBLICATION_DATE
        ) VALUES (
            #{alertId},
            #{ingredientId},
            #{nation},
            #{hazardType},
            #{title},
            #{description},
            SYSTIMESTAMP
        )
    </insert>

    <!-- 안전 정보 수정 -->
    <update id="updateAlert">
        UPDATE SAFETY_ALERT_MASTER
        SET 
            NATION = #{nation},
            HAZARD_TYPE = #{hazardType},
            TITLE = #{title},
            DESCRIPTION = #{description}
        WHERE ALERT_ID = #{alertId}
    </update>

    <!-- 안전 정보 삭제 (다중 삭제) -->
    <delete id="deleteAlerts">
        DELETE FROM SAFETY_ALERT_MASTER
        WHERE ALERT_ID IN
        <foreach collection="list" item="alertId" open="(" separator="," close=")">
            #{alertId}
        </foreach>
    </delete>
  
  </mapper>