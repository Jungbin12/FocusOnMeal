<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.alert.model.mapper.PriceAlertMapper">

    <!-- ===== 기존 단일 알림용 쿼리 ===== -->

    <!-- 회원의 특정 식재료 가격 알림 설정 확인 -->
    <select id="countPriceAlert" resultType="int">
        SELECT COUNT(*)
        FROM PRICE_ALERT_SETTING
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </select>

    <!-- 특정 식재료 가격 알림 등록 -->
    <insert id="insertPriceAlert">
        INSERT INTO PRICE_ALERT_SETTING (
            ALERT_ID,
            MEMBER_ID,
            INGREDIENT_ID,
            THRESHOLD_PRICE,
            NOTIFICATION_ENABLED
        ) VALUES (
            SEQ_PRICE_ALERT_SETTING.NEXTVAL,
            #{memberId},
            #{ingredientId},
            0,
            'Y'
        )
    </insert>

    <!-- 특정 식재료 가격 알림 해제 -->
    <delete id="deletePriceAlert">
        DELETE FROM PRICE_ALERT_SETTING
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </delete>

    <!-- 가격 알림이 설정된 모든 고유 식재료 ID 조회 -->
    <select id="selectAllPriceAlertIngredientIds" resultType="int">
        SELECT DISTINCT INGREDIENT_ID
        FROM PRICE_ALERT_SETTING
        WHERE NOTIFICATION_ENABLED = 'Y'
        ORDER BY INGREDIENT_ID
    </select>

    <!-- 특정 식재료에 대해 가격 알림이 활성화된 회원 목록 조회 -->
    <select id="selectMembersWithPriceAlertEnabled" resultType="string">
        SELECT DISTINCT pas.MEMBER_ID
        FROM PRICE_ALERT_SETTING pas
        INNER JOIN SAFETY_ALERT_SETTINGS sas
            ON pas.MEMBER_ID = sas.MEMBER_ID
        WHERE pas.INGREDIENT_ID = #{ingredientId}
          AND pas.NOTIFICATION_ENABLED = 'Y'
          AND sas.NOTIFICATION_ENABLED = 'Y'
    </select>

    <!-- 내 가격 알림 설정 조회 -->
    <select id="selectMySetting" resultType="com.fom.boot.domain.alert.model.vo.PriceAlert">
        SELECT
            ALERT_ID             AS alertId,
            MEMBER_ID            AS memberId,
            INGREDIENT_ID        AS ingredientId,
            THRESHOLD_PRICE      AS thresholdPrice,
            NOTIFICATION_ENABLED AS notificationEnabled
        FROM PRICE_ALERT_SETTING
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
        FETCH FIRST 1 ROW ONLY
    </select>

    <!-- 가격 알림 설정 업데이트 -->
    <update id="updatePriceAlert" parameterType="com.fom.boot.domain.alert.model.vo.PriceAlert">
        UPDATE PRICE_ALERT_SETTING
        SET THRESHOLD_PRICE = #{thresholdPrice},
            NOTIFICATION_ENABLED = 'Y'
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </update>

    <!-- 가격 임계값을 초과한 회원 목록 조회 (배치용) -->
    <select id="selectTargetMemberIds" resultType="string">
        SELECT DISTINCT MEMBER_ID
        FROM PRICE_ALERT_SETTING
        WHERE INGREDIENT_ID = #{ingredientId}
          AND NOTIFICATION_ENABLED = 'Y'
          AND THRESHOLD_PRICE >= #{currentPrice}
    </select>

    <!-- ===== 새로운 다중 알림용 쿼리 ===== -->

    <!-- 특정 재료의 모든 알림 조회 -->
    <select id="selectAllAlerts" resultType="com.fom.boot.domain.alert.model.vo.PriceAlert">
        SELECT
            ALERT_ID             AS alertId,
            MEMBER_ID            AS memberId,
            INGREDIENT_ID        AS ingredientId,
            THRESHOLD_PRICE      AS thresholdPrice,
            NOTIFICATION_ENABLED AS notificationEnabled
        FROM PRICE_ALERT_SETTING
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
        ORDER BY THRESHOLD_PRICE ASC
    </select>

    <!-- 알림 추가 (다중 알림용) -->
    <insert id="insertPriceAlertNew" parameterType="com.fom.boot.domain.alert.model.vo.PriceAlert">
        INSERT INTO PRICE_ALERT_SETTING (
            ALERT_ID,
            MEMBER_ID,
            INGREDIENT_ID,
            THRESHOLD_PRICE,
            NOTIFICATION_ENABLED
        ) VALUES (
            SEQ_PRICE_ALERT_SETTING.NEXTVAL,
            #{memberId},
            #{ingredientId},
            #{thresholdPrice},
            #{notificationEnabled}
        )
    </insert>

    <!-- 개별 알림 삭제 -->
    <delete id="deleteAlertById">
        DELETE FROM PRICE_ALERT_SETTING
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
          AND ALERT_ID = #{alertId}
    </delete>

    <!-- 특정 재료의 모든 알림 삭제 -->
    <delete id="deleteAllAlerts">
        DELETE FROM PRICE_ALERT_SETTING
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </delete>

  </mapper>