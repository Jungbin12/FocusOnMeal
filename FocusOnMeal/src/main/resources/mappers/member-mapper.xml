<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fom.boot.domain.member.model.mapper.MemberMapper">

    <!-- 로그인 -->
    <select id="selectOneByLogin"
            parameterType="com.fom.boot.app.member.dto.LoginRequest"
            resultType="com.fom.boot.domain.member.model.vo.Member">
        SELECT 
            MEMBER_ID,
            MEMBER_PW,
            MEMBER_NAME,
            MEMBER_NICKNAME,
            EMAIL,
            PHONE,
            GENDER,
            ENROLL_DATE,
            STATUS_YN,
            ADMIN_YN
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
    </select>

    <!-- Spring Security: 회원 조회 -->
    <select id="findByMemberId"
            parameterType="String"
            resultType="com.fom.boot.domain.member.model.vo.Member">
        SELECT
            MEMBER_ID,
            MEMBER_PW,
            MEMBER_NAME,
            MEMBER_NICKNAME,
            EMAIL,
            PHONE,
            GENDER,
            ENROLL_DATE,
            STATUS_YN,
            ADMIN_YN
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
          AND STATUS_YN = 'Y'
    </select>

    <!-- 회원가입 -->
    <insert id="insertMember"
            parameterType="com.fom.boot.domain.member.model.vo.Member">
        INSERT INTO MEMBER (
            MEMBER_ID, MEMBER_PW, MEMBER_NAME,
            MEMBER_NICKNAME, EMAIL, PHONE,
            GENDER, ENROLL_DATE, STATUS_YN, ADMIN_YN
        ) VALUES (
            #{memberId},
            #{memberPw},
            #{memberName},
            #{memberNickname},
            #{email},
            #{phone},
            #{gender},
            DEFAULT,
            DEFAULT,
            DEFAULT
        )
    </insert>

    <!-- 닉네임 변경 -->
    <update id="updateNickname">
        UPDATE MEMBER
        SET MEMBER_NICKNAME = #{memberNickname}
        WHERE MEMBER_ID = #{memberId}
    </update>

    <!-- 비밀번호 변경 -->
    <update id="updateMemberPassword">
        UPDATE MEMBER
        SET MEMBER_PW = #{encodedPw}
        WHERE MEMBER_ID = #{memberId}
    </update>

    <!-- 아이디 찾기 -->
    <select id="searchMemberId" parameterType="map" resultType="String">
	  SELECT MEMBER_ID
	  FROM MEMBER
	  WHERE MEMBER_NAME = #{memberName}
	    AND EMAIL = #{email}
	    AND STATUS_YN = 'Y'
	  FETCH FIRST 1 ROWS ONLY
	</select>

    <!-- 회원 조회 -->
    <select id="selectOneById"
            parameterType="String"
            resultType="com.fom.boot.domain.member.model.vo.Member">
        SELECT 
            MEMBER_ID,
            MEMBER_PW,
            MEMBER_NAME,
            MEMBER_NICKNAME,
            EMAIL,
            PHONE,
            GENDER,
            ENROLL_DATE,
            STATUS_YN,
            ADMIN_YN
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
          AND STATUS_YN = 'Y'
    </select>

    <!-- 이메일 중복 체크 -->
    <select id="checkEmailExists"
            parameterType="String"
            resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE EMAIL = #{email}
          AND STATUS_YN = 'Y'
    </select>
    
    <!-- 프로필 수정 -->
	<update id="updateProfile" parameterType="Member">
	    UPDATE member
	    SET member_nickname = #{memberNickname},
	        phone = #{phone},
	        member_pw = #{memberPw}
	    WHERE member_id = #{memberId}
	</update>
	
	<!-- 회원 관련 데이터 삭제 -->
	<delete id="deleteUserAllergies" parameterType="String">
	    DELETE FROM member_allergy WHERE member_id = #{memberId}
	</delete>
	
	<delete id="deleteUserMealPlans" parameterType="String">
	    DELETE FROM meal_plan WHERE member_id = #{memberId}
	</delete>
	
	<delete id="deleteUserFavorites" parameterType="string">
	    DELETE FROM FAVORITE
	    WHERE MEMBER_ID = #{memberId}
	</delete>
	
	<!-- 회원 삭제 -->
	<delete id="deleteMember" parameterType="String">
	    DELETE FROM member WHERE member_id = #{memberId}
	</delete>
    
    <!-- 관리자 영역 시작 -->
	<!-- ************************************************************************ -->
	
    <!-- 관리자: 전체 회원 목록 조회 -->
	<select id="selectAllMembers" resultType="com.fom.boot.domain.member.model.vo.Member">
	    SELECT *
	    FROM (
	        SELECT A.*, ROWNUM AS rnum
	        FROM (
	            SELECT *
	            FROM MEMBER
	            <where>
	                <!-- 전체 검색 ('all')이면 아래 조건 무시 -->
	                <if test="type == 'all' and keyword != null and keyword != ''">
	                    (
	                        MEMBER_ID LIKE '%' || #{keyword} || '%'
	                        OR MEMBER_NAME LIKE '%' || #{keyword} || '%'
	                        OR MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
	                    )
	                </if>
	
	                <!-- 특정 항목 검색 -->
	                <if test="type != 'all' and keyword != null and keyword != ''">
	                    <choose>
	                        <when test="type == 'memberId'">
	                            AND MEMBER_ID LIKE '%' || #{keyword} || '%'
	                        </when>
	                        <when test="type == 'memberName'">
	                            AND MEMBER_NAME LIKE '%' || #{keyword} || '%'
	                        </when>
	                        <when test="type == 'memberNickname'">
	                            AND MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
	                        </when>
	                    </choose>
	                </if>
	            </where>
	            
	            <!-- 정렬 추가 -->
	            ORDER BY 
            	<choose>
	                <when test="sortColumn == 'memberId'"> MEMBER_ID </when>
	                <when test="sortColumn == 'memberName'"> MEMBER_NAME </when>
	                <when test="sortColumn == 'memberNickname'"> MEMBER_NICKNAME </when>
	                <when test="sortColumn == 'phone'"> PHONE </when>
	                <when test="sortColumn == 'email'"> EMAIL </when>
	                <when test="sortColumn == 'gender'"> GENDER </when>
	                <when test="sortColumn == 'enrollDate'"> ENROLL_DATE </when>
	                <when test="sortColumn == 'adminYn'"> ADMIN_YN </when>
	                <when test="sortColumn == 'statusYn'"> STATUS_YN </when>
	
	                <!-- 기본 정렬 = 가입일 최신순 -->
	                <otherwise> ENROLL_DATE </otherwise>
	            </choose>
	            	
	            <!-- asc / desc -->
	            <choose>
	                <when test="sortOrder == 'asc'"> ASC </when>
	                <otherwise> DESC </otherwise>
	            </choose>
	        ) A
	    )
	    WHERE rnum BETWEEN #{startRow} AND #{endRow}
	</select>

	<!-- 관리자: 닉네임 변경 + 관리자 권한 부여 -->
    <update id="updateAdminNickname">
        UPDATE MEMBER
        SET 
            ADMIN_YN = #{adminYn},
            MEMBER_NICKNAME = #{memberNickname}
        WHERE MEMBER_ID = #{memberId}
    </update>
	
	<!-- 관리자 : 회원 상태 변경 -->
	<update id="updateStatusYn">
	    UPDATE MEMBER
	    SET STATUS_YN = #{statusYn}
	    WHERE MEMBER_ID = #{memberId}
	</update>
	
	<!-- 관리자 : 총 회원 수 -->
	<select id="getTotalMembersBySearch" resultType="int">
    SELECT COUNT(*)
        FROM MEMBER
        <where>
            <if test="type == 'all' and keyword != null and keyword != ''">
                ( MEMBER_ID LIKE '%' || #{keyword} || '%'
                  OR MEMBER_NAME LIKE '%' || #{keyword} || '%'
                  OR MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
                )
            </if>
    
            <if test="type != 'all' and keyword != null and keyword != ''">
                <choose>
                    <when test="type == 'memberId'">
                        MEMBER_ID LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="type == 'memberName'">
                        MEMBER_NAME LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="type == 'memberNickname'">
                        MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
                    </when>
                </choose>
            </if>
        </where>
    </select>
  </mapper>
