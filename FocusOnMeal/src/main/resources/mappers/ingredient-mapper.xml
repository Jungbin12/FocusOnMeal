<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.ingredient.model.mapper.IngredientMapper">
  	
  	<!-- 찜 등록 및 해제 resultMap -->
  	<resultMap id="FavoriteIngredient" type="com.fom.boot.domain.ingredient.model.vo.FavoriteIngredient">
  		<id			property="favoriteId"	column="FAVORITE_ID" 	/>
  		<result 	property="memberId"		column="MEMBER_ID"	 	/>
  		<result 	property="ingredientId"	column="INGREDIENT_ID"	/>
  		<result		property="isCustom"		column="IS_CUSTOM"		/>
  	</resultMap>
  	
  	<!-- 찜한 식재료 목록 조회 (마이페이지용) -->
	<select id="selectFavoritesByMemberId" resultType="com.fom.boot.app.mypage.dto.FavoriteIngredientSummaryDTO">
	    SELECT 
	        F.FAVORITE_ID as favoriteId,
	        F.MEMBER_ID as memberId,
	        F.INGREDIENT_ID as ingredientId,
	        F.IS_CUSTOM as isCustom,
	        I.NAME as ingredientName,
	        I.CATEGORY as category,
	        I.STANDARD_UNIT as standardUnit,
	        P.PRICE_VALUE as currentPrice
	    FROM FAVORITE F
	    INNER JOIN INGREDIENT_MASTER I ON F.INGREDIENT_ID = I.INGREDIENT_ID
	    LEFT JOIN (
	        SELECT INGREDIENT_ID, PRICE_VALUE
	        FROM (
	            SELECT 
	                INGREDIENT_ID, 
	                PRICE_VALUE,
	                ROW_NUMBER() OVER(PARTITION BY INGREDIENT_ID ORDER BY COLLECTED_DATE DESC) as RN
	            FROM PRICE_HISTORY
	            WHERE REGION = '서울' AND PRICE_TYPE = '소매'
	        )
	        WHERE RN = 1
	    ) P ON I.INGREDIENT_ID = P.INGREDIENT_ID
	    WHERE F.MEMBER_ID = #{memberId}
	    ORDER BY F.FAVORITE_ID DESC
	</select>
  	
  	<!-- 찜 등록 -->
    <insert id="insertFavorite" parameterType="com.fom.boot.domain.ingredient.model.vo.FavoriteIngredient">
        <!-- 오라클 시퀀스를 사용한 자동 번호 생성 -->
        <selectKey keyProperty="favoriteId" resultType="int" order="BEFORE">
            SELECT SEQ_FAVORITE.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO FAVORITE (
            FAVORITE_ID,
            MEMBER_ID,
            INGREDIENT_ID,
            IS_CUSTOM
        ) VALUES (
            #{favoriteId},
            #{memberId},
            #{ingredientId},
            #{isCustom}
        )
    </insert>
    
    <!-- 찜 해제 -->
    <delete id="deleteFavorite">
    	DELETE FROM FAVORITE
    	WHERE MEMBER_ID = #{memberId}
    	AND INGREDIENT_ID = #{ingredientId}
    </delete>
    
    <!-- 찜 존재 여부 확인 -->
    <select id="checkFavoriteExists" resultType="int">
        SELECT COUNT(*)
        FROM FAVORITE
        WHERE MEMBER_ID = #{memberId}
        AND INGREDIENT_ID = #{ingredientId}
    </select>

    <!-- Ingredient  -->
    <resultMap id="IngredientResultMap" type="com.fom.boot.domain.ingredient.model.vo.Ingredient">
        <id property="ingredientId" column="INGREDIENT_ID" />
        <result property="name" column="NAME" />
        <result property="category" column="CATEGORY" />
        <result property="standardUnit" column="STANDARD_UNIT" />
        <result property="kamisItemCode" column="KAMIS_ITEM_CODE" />
        <result property="kamisKindCode" column="KAMIS_KIND_CODE" />
        <result property="kamisItemCategoryCode" column="KAMIS_ITEM_CATEGORY_CODE" />
    </resultMap>

    <!-- ID로 식자재 조회 -->
    <select id="selectById" parameterType="int" resultMap="IngredientResultMap">
        SELECT INGREDIENT_ID, NAME, CATEGORY, STANDARD_UNIT,
               KAMIS_ITEM_CODE, KAMIS_KIND_CODE, KAMIS_ITEM_CATEGORY_CODE
        FROM INGREDIENT_MASTER
        WHERE INGREDIENT_ID = #{ingredientId}
    </select>

    <!-- KAMIS 코드로 식자재 조회 -->
    <select id="selectByKamisCode" resultMap="IngredientResultMap">
        SELECT INGREDIENT_ID, NAME, CATEGORY, STANDARD_UNIT,
               KAMIS_ITEM_CODE, KAMIS_KIND_CODE, KAMIS_ITEM_CATEGORY_CODE
        FROM INGREDIENT_MASTER
        WHERE KAMIS_ITEM_CODE = #{kamisItemCode}
        AND KAMIS_KIND_CODE = #{kamisKindCode}
    </select>

    <!-- 식자재 등록 -->
    <insert id="insertIngredient" parameterType="com.fom.boot.domain.ingredient.model.vo.Ingredient">
        <selectKey keyProperty="ingredientId" resultType="int" order="BEFORE">
            SELECT SEQ_INGREDIENT_MASTER.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO INGREDIENT_MASTER (
            INGREDIENT_ID,
            NAME,
            CATEGORY,
            STANDARD_UNIT,
            KAMIS_ITEM_CODE,
            KAMIS_KIND_CODE,
            KAMIS_ITEM_CATEGORY_CODE
        ) VALUES (
            #{ingredientId},
            #{name},
            #{category},
            #{standardUnit},
            #{kamisItemCode},
            #{kamisKindCode},
            #{kamisItemCategoryCode}
        )
    </insert>
    
	<resultMap id="IngredientWithPriceMap" 
               type="com.fom.boot.app.ingredient.dto.IngredientDTO" 
               extends="IngredientResultMap">
        
        <!-- column 이름을 쿼리의 AS 별칭과 정확히 일치시킴 -->
        <result property="currentPrice" column="CURRENT_PRICE" />
        <result property="collectedDate" column="COLLECTED_DATE" />
        
        <!-- 추가된 필드 매핑 -->
        <result property="previousPrice" column="PREVIOUS_PRICE" />
        <result property="previousCollectedDate" column="PREVIOUS_COLLECTED_DATE" />
        <result property="priceChangePercent" column="PRICE_CHANGE_PERCENT" />
    </resultMap>

	<!-- 리스트 페이지용: 전체 목록 + 최신 가격 조회 (서울/소매 기준) -->
	<select id="getIngredientList" resultMap="IngredientWithPriceMap">
	    SELECT 
	        M.INGREDIENT_ID,
	        M.NAME,
	        M.CATEGORY,
	        M.STANDARD_UNIT,
	        M.KAMIS_ITEM_CODE,
	        M.KAMIS_KIND_CODE,
	        M.KAMIS_ITEM_CATEGORY_CODE,
	        
	        P.PRICE_VALUE AS CURRENT_PRICE,
	        P.COLLECTED_DATE AS COLLECTED_DATE,
	        
	        NVL(P.PREVIOUS_PRICE, 0) AS PREVIOUS_PRICE,
	        P.PREVIOUS_COLLECTED_DATE,
	        
	        CASE 
	            WHEN P.PREVIOUS_PRICE > 0 THEN 
	                ROUND(((P.PRICE_VALUE - P.PREVIOUS_PRICE) / P.PREVIOUS_PRICE) * 100, 1)
	            ELSE 0 
	        END AS PRICE_CHANGE_PERCENT
	        
	    FROM (
	        SELECT 
	            INGREDIENT_ID,
	            NAME,
	            CATEGORY,
	            STANDARD_UNIT,
	            KAMIS_ITEM_CODE,
	            KAMIS_KIND_CODE,
	            KAMIS_ITEM_CATEGORY_CODE,
	            ROW_NUMBER() OVER(PARTITION BY NAME ORDER BY KAMIS_KIND_CODE ASC) as RN
	        FROM INGREDIENT_MASTER
	    ) M
	    LEFT JOIN (
	        SELECT 
	            INGREDIENT_ID, 
	            PRICE_VALUE, 
	            COLLECTED_DATE,
	            
	            LEAD(PRICE_VALUE, 1) OVER (PARTITION BY INGREDIENT_ID ORDER BY COLLECTED_DATE DESC) AS PREVIOUS_PRICE,
	            LEAD(COLLECTED_DATE, 1) OVER (PARTITION BY INGREDIENT_ID ORDER BY COLLECTED_DATE DESC) AS PREVIOUS_COLLECTED_DATE,
	            
	            ROW_NUMBER() OVER(PARTITION BY INGREDIENT_ID ORDER BY COLLECTED_DATE DESC) as RN
	        FROM PRICE_HISTORY
	        WHERE REGION = '서울' 
	          AND PRICE_TYPE = '소매'
	    ) P ON M.INGREDIENT_ID = P.INGREDIENT_ID AND P.RN = 1 -- 최신 데이터 행만 조인
	    
	    WHERE M.RN = 1 
	    ORDER BY M.NAME ASC
	</select>

    <!-- 관리자(Admin) 전용 매핑 및 쿼리 -->

    <!-- 관리자 DTO 매핑 (영양성분 필드 포함, 추후 조인 시 사용 대비) -->
    <resultMap id="AdminIngredientMap" type="com.fom.boot.app.admin.dto.AdminIngredientDTO">
        <!-- INGREDIENT_MASTER 테이블 -->
        <id property="ingredientId" column="INGREDIENT_ID"/>
        <result property="name" column="NAME"/>
        <result property="category" column="CATEGORY"/>
        <result property="standardUnit" column="STANDARD_UNIT"/>
        <result property="kamisItemCode" column="KAMIS_ITEM_CODE"/>
        <result property="kamisKindCode" column="KAMIS_KIND_CODE"/>
        <!-- 등록일 컬럼이 있다면 추가 (예: ENROLL_DATE) -->
        
        <!-- NUTRITION_MASTER 테이블 (현재는 JOIN 안하므로 null로 매핑됨) -->
        <result property="nutritionId" column="NUTRITION_ID"/>
        <result property="calories" column="CALORIES"/>
        <result property="carbsG" column="CARBS_G"/>
        <result property="proteinG" column="PROTEIN_G"/>
        <result property="fatG" column="FAT_G"/>
        <result property="sugarG" column="SUGAR_G"/>
    </resultMap>

    <!-- 관리자 검색 조건 (SQL Fragment) -->
    <sql id="searchFrag">
        <where>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="type == 'ingredientName'">
                        AND NAME LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="type == 'categoryName'">
                        AND CATEGORY LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <otherwise>
                        AND (NAME LIKE CONCAT('%', #{keyword}, '%')
                             OR CATEGORY LIKE CONCAT('%', #{keyword}, '%'))
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>

    <!-- [관리자] 식재료 총 개수 조회 -->
    <select id="selectAdminTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM INGREDIENT_MASTER
        <include refid="searchFrag"/>
    </select>

    <!-- [관리자] 식재료 목록 조회 (Oracle 12c+ Paging) -->
    <select id="selectAdminList" resultMap="AdminIngredientMap">
        SELECT 
            INGREDIENT_ID,
            NAME,
            CATEGORY,
            STANDARD_UNIT,
            KAMIS_ITEM_CODE,
            KAMIS_KIND_CODE
            <!-- , ENROLL_DATE -->
        FROM INGREDIENT_MASTER
        <include refid="searchFrag"/>
        <choose>
            <when test="sortColumn != null and sortColumn != ''">
                ORDER BY ${sortColumn} ${sortOrder}
            </when>
            <otherwise>
                ORDER BY INGREDIENT_ID DESC
            </otherwise>
        </choose>
        <!-- 오라클 12c 이상 페이징 문법 -->
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- [관리자] 영양성분 수정 -->
    <update id="updateNutrition">
        UPDATE NUTRITION_MASTER
        SET 
            CALORIES = #{calories},
            CARBS_G = #{carbsG},
            PROTEIN_G = #{proteinG},
            FAT_G = #{fatG},
            SUGAR_G = #{sugarG}
        WHERE NUTRITION_ID = #{nutritionId}
    </update>

    <!-- [관리자] 영양성분 등록 -->
    <insert id="insertNutrition">
        INSERT INTO NUTRITION_MASTER (
            INGREDIENT_ID,
            MEASURE_UNIT,
            CALORIES,
            CARBS_G,
            PROTEIN_G,
            FAT_G,
            SUGAR_G
        ) VALUES (
            #{ingredientId},
            '100g',
            #{calories},
            #{carbsG},
            #{proteinG},
            #{fatG},
            #{sugarG}
        )
    </insert>


  </mapper>