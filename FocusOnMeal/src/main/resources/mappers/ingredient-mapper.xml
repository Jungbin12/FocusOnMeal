<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.ingredient.model.mapper.IngredientMapper">
  	
  	<!-- 찜 등록 및 해제 resultMap -->
  	<resultMap id="FavoriteIngredient" type="com.fom.boot.domain.ingredient.model.vo.FavoriteIngredient">
  		<id			property="favoriteId"	column="FAVORITE_ID" 	/>
  		<result 	property="memberId"		column="MEMBER_ID"	 	/>
  		<result 	property="ingredientId"	column="INGREDIENT_ID"	/>
  		<result		property="isCustom"		column="IS_CUSTOM"		/>
  	</resultMap>
  	
  	<!-- 찜 등록 -->
    <insert id="insertFavorite" parameterType="com.fom.boot.domain.ingredient.model.vo.FavoriteIngredient">
        <!-- 오라클 시퀀스를 사용한 자동 번호 생성 -->
        <selectKey keyProperty="favoriteId" resultType="int" order="BEFORE">
            SELECT SEQ_FAVORITE_ID.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO FAVORITE (
            FAVORITE_ID,
            MEMBER_ID,
            INGREDIENT_ID,
            IS_CUSTOM
        ) VALUES (
            #{favoriteId},
            #{memberId},
            #{ingredientId},
            #{isCustom}
        )
    </insert>
    
    <!-- 찜 해제 -->
    <delete id="deleteFavorite">
    	DELETE FROM FAVORITE
    	WHERE MEMBER_ID = #{memberId}
    	AND INGREDIENT_ID = #{ingredientId}
    </delete>
    
    <!-- 찜 존재 여부 확인 -->
    <select id="checkFavoriteExists" resultType="int">
        SELECT COUNT(*)
        FROM FAVORITE
        WHERE MEMBER_ID = #{memberId}
        AND INGREDIENT_ID = #{ingredientId}
    </select>

    <!-- Ingredient  -->
    <resultMap id="IngredientResultMap" type="com.fom.boot.domain.ingredient.model.vo.Ingredient">
        <id property="ingredientId" column="INGREDIENT_ID" />
        <result property="name" column="NAME" />
        <result property="category" column="CATEGORY" />
        <result property="standardUnit" column="STANDARD_UNIT" />
        <result property="kamisItemCode" column="KAMIS_ITEM_CODE" />
        <result property="kamisKindCode" column="KAMIS_KIND_CODE" />
        <result property="kamisItemCategoryCode" column="KAMIS_ITEM_CATEGORY_CODE" />
    </resultMap>

    <!-- ID로 식자재 조회 -->
    <select id="selectById" parameterType="int" resultMap="IngredientResultMap">
        SELECT INGREDIENT_ID, NAME, CATEGORY, STANDARD_UNIT,
               KAMIS_ITEM_CODE, KAMIS_KIND_CODE, KAMIS_ITEM_CATEGORY_CODE
        FROM INGREDIENT_MASTER
        WHERE INGREDIENT_ID = #{ingredientId}
    </select>

    <!-- KAMIS 코드로 식자재 조회 -->
    <select id="selectByKamisCode" resultMap="IngredientResultMap">
        SELECT INGREDIENT_ID, NAME, CATEGORY, STANDARD_UNIT,
               KAMIS_ITEM_CODE, KAMIS_KIND_CODE, KAMIS_ITEM_CATEGORY_CODE
        FROM INGREDIENT_MASTER
        WHERE KAMIS_ITEM_CODE = #{kamisItemCode}
        AND KAMIS_KIND_CODE = #{kamisKindCode}
    </select>

    <!-- 식자재 등록 -->
    <insert id="insertIngredient" parameterType="com.fom.boot.domain.ingredient.model.vo.Ingredient">
        <selectKey keyProperty="ingredientId" resultType="int" order="BEFORE">
            SELECT SEQ_INGREDIENT_MASTER.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO INGREDIENT_MASTER (
            INGREDIENT_ID,
            NAME,
            CATEGORY,
            STANDARD_UNIT,
            KAMIS_ITEM_CODE,
            KAMIS_KIND_CODE,
            KAMIS_ITEM_CATEGORY_CODE
        ) VALUES (
            #{ingredientId},
            #{name},
            #{category},
            #{standardUnit},
            #{kamisItemCode},
            #{kamisKindCode},
            #{kamisItemCategoryCode}
        )
    </insert>
    
	<resultMap id="IngredientWithPriceMap" 
               type="com.fom.boot.app.ingredient.dto.IngredientDTO" 
               extends="IngredientResultMap">
        
        <!-- DTO에 추가된 필드만 매핑 -->
        <result property="currentPrice" column="PRICE_VALUE" />
        <result property="collectedDate" column="COLLECTED_DATE" />
    </resultMap>

    <!-- 리스트 페이지용: 전체 목록 + 최신 가격 조회 (서울/소매 기준) -->
    <select id="selectListWithLatestPrice" resultMap="IngredientWithPriceMap">
        SELECT 
            M.INGREDIENT_ID,
            M.NAME,
            M.CATEGORY,
            M.STANDARD_UNIT,
            M.KAMIS_ITEM_CODE,
            M.KAMIS_KIND_CODE,
            M.KAMIS_ITEM_CATEGORY_CODE,
            P.PRICE_VALUE,
            P.COLLECTED_DATE
        FROM INGREDIENT_MASTER M
        LEFT JOIN (
            SELECT INGREDIENT_ID, PRICE_VALUE, COLLECTED_DATE
            FROM (
                SELECT 
                    INGREDIENT_ID, 
                    PRICE_VALUE, 
                    COLLECTED_DATE,
                    ROW_NUMBER() OVER(PARTITION BY INGREDIENT_ID ORDER BY COLLECTED_DATE DESC) as RN
                FROM PRICE_HISTORY
                WHERE REGION = '서울' 
                  AND PRICE_TYPE = '소매'
            )
            WHERE RN = 1
        ) P ON M.INGREDIENT_ID = P.INGREDIENT_ID
        ORDER BY M.NAME ASC
    </select>

  </mapper>