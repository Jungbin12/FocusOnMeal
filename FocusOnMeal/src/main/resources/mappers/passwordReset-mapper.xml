<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.member.model.mapper.PasswordResetMapper">
  
  <!-- ResultMap 정의 -->
    <resultMap id="passwordResetTokenResultMap" type="PasswordResetToken">
        <id property="tokenId" column="TOKEN_ID"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="token" column="TOKEN"/>
        <result property="expireDate" column="EXPIRE_DATE"/>
        <result property="usedYn" column="USED_YN"/>
        <result property="ipAddress" column="IP_ADDRESS"/>
        <result property="userAgent" column="USER_AGENT"/>
        <result property="createdDate" column="CREATED_DATE"/>
        <result property="usedDate" column="USED_DATE"/>
    </resultMap>

    <!-- 1. 토큰 저장 -->
    <insert id="insertPasswordResetToken" parameterType="PasswordResetToken">
        INSERT INTO PASSWORD_RESET_TOKEN (
            TOKEN_ID,
            MEMBER_ID,
            TOKEN,
            EXPIRE_DATE,
            USED_YN,
            IP_ADDRESS,
            USER_AGENT,
            CREATED_DATE
        ) VALUES (
            SEQ_TOKEN_ID.NEXTVAL,
            #{memberId},
            #{token},
            #{expireDate},
            'N',
            #{ipAddress},
            #{userAgent},
            SYSTIMESTAMP
        )
    </insert>

    <!-- 2. 토큰으로 토큰 정보 조회 -->
    <select id="selectTokenByToken" parameterType="String" 
            resultMap="passwordResetTokenResultMap">
        SELECT 
            TOKEN_ID,
            MEMBER_ID,
            TOKEN,
            EXPIRE_DATE,
            USED_YN,
            IP_ADDRESS,
            USER_AGENT,
            CREATED_DATE,
            USED_DATE
        FROM PASSWORD_RESET_TOKEN
        WHERE TOKEN = #{token}
    </select>

    <!-- 3. 토큰 유효성 검증 -->
    <select id="countValidToken" parameterType="String" resultType="int">
        SELECT COUNT(*)
        FROM PASSWORD_RESET_TOKEN
        WHERE TOKEN = #{token}
          AND EXPIRE_DATE > SYSTIMESTAMP
          AND USED_YN = 'N'
    </select>

    <!-- 4. 토큰으로 회원 ID 조회 (유효한 토큰만) -->
    <select id="selectMemberIdByToken" parameterType="String" resultType="String">
        SELECT MEMBER_ID
        FROM PASSWORD_RESET_TOKEN
        WHERE TOKEN = #{token}
          AND EXPIRE_DATE > SYSTIMESTAMP
          AND USED_YN = 'N'
        FETCH FIRST 1 ROW ONLY
    </select>

    <!-- 5. 토큰 사용 처리 -->
    <update id="updateTokenAsUsed" parameterType="String">
        UPDATE PASSWORD_RESET_TOKEN
        SET USED_YN = 'Y',
            USED_DATE = SYSTIMESTAMP
        WHERE TOKEN = #{token}
    </update>

    <!-- 6. 회원의 기존 미사용 토큰 모두 무효화 -->
    <update id="updateInvalidateOldTokens" parameterType="String">
        UPDATE PASSWORD_RESET_TOKEN
        SET USED_YN = 'Y',
            USED_DATE = SYSTIMESTAMP
        WHERE MEMBER_ID = #{memberId}
          AND USED_YN = 'N'
    </update>

    <!-- 7. 회원의 토큰 발급 이력 조회 -->
    <select id="selectTokenHistoryByMemberId" resultMap="passwordResetTokenResultMap">
        SELECT 
            TOKEN_ID,
            MEMBER_ID,
            TOKEN,
            EXPIRE_DATE,
            USED_YN,
            IP_ADDRESS,
            USER_AGENT,
            CREATED_DATE,
            USED_DATE
        FROM (
            SELECT *
            FROM PASSWORD_RESET_TOKEN
            WHERE MEMBER_ID = #{memberId}
            ORDER BY CREATED_DATE DESC
        )
        <if test="limit > 0">
            FETCH FIRST #{limit} ROWS ONLY
        </if>
    </select>

    <!-- 8. 특정 기간 내 회원의 토큰 요청 횟수 -->
    <select id="countTokenRequestsByMemberId" resultType="int">
        SELECT COUNT(*)
        FROM PASSWORD_RESET_TOKEN
        WHERE MEMBER_ID = #{memberId}
          AND CREATED_DATE > SYSTIMESTAMP - INTERVAL '#{hours}' HOUR
    </select>

    <!-- 9. 특정 기간 내 IP의 토큰 요청 횟수 -->
    <select id="countTokenRequestsByIp" resultType="int">
        SELECT COUNT(*)
        FROM PASSWORD_RESET_TOKEN
        WHERE IP_ADDRESS = #{ipAddress}
          AND CREATED_DATE > SYSTIMESTAMP - INTERVAL '#{hours}' HOUR
    </select>

    <!-- 10. 만료된 토큰 삭제 -->
    <delete id="deleteExpiredTokens">
        DELETE FROM PASSWORD_RESET_TOKEN
        WHERE EXPIRE_DATE &lt; SYSTIMESTAMP
    </delete>

    <!-- 11. 사용 완료된 오래된 토큰 삭제 -->
    <delete id="deleteOldUsedTokens" parameterType="int">
        DELETE FROM PASSWORD_RESET_TOKEN
        WHERE USED_YN = 'Y'
          AND USED_DATE &lt; SYSTIMESTAMP - INTERVAL '#{days}' DAY
    </delete>
  
  
  </mapper>