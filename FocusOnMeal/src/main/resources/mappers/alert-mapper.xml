<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.alert.model.mapper.AlertMapper">
  
      <!-- 회원의 알림 목록 조회 (제목 포함) -->
    <select id="selectNotificationsByMemberId" resultType="map">
        SELECT
        "notificationId",
        "memberId",
        "type",
        "message",
        "isRead",
        "sentAt",
        "title",
        "alertId",
        "ingredientId"
    FROM (
        SELECT
            nl.NOTIFICATION_ID AS "notificationId",
            nl.MEMBER_ID AS "memberId",
            nl.TYPE AS "type",
            nl.MESSAGE AS "message",
            nl.IS_READ AS "isRead",
            TO_CHAR(nl.SENT_AT, 'YYYY-MM-DD"T"HH24:MI:SS') AS "sentAt",
            NVL(sam.TITLE, '알림') AS "title",
            sam.ALERT_ID AS "alertId",
            CASE
                WHEN nl.TYPE IN ('가격정보', '가격변동') AND nl.MESSAGE LIKE '%||%' THEN
                    TO_NUMBER(SUBSTR(nl.MESSAGE, INSTR(nl.MESSAGE, '||') + 2))
                ELSE sam.INGREDIENT_ID
            END AS "ingredientId",
            ROW_NUMBER() OVER (PARTITION BY nl.NOTIFICATION_ID ORDER BY sam.ALERT_ID DESC NULLS LAST) AS rn
        FROM NOTIFICATION_LOG nl
        LEFT JOIN SAFETY_ALERT_MASTER sam
            ON nl.TYPE = '위험공표'
            AND (
                sam.TITLE = TRIM(SUBSTR(nl.MESSAGE, INSTR(nl.MESSAGE, ' - ') + 3))
                OR
                INSTR(nl.MESSAGE, sam.TITLE) > 0
            )
        WHERE nl.MEMBER_ID = #{memberId}
          AND nl.IS_READ = 'N'
    )
    WHERE rn = 1
    ORDER BY "sentAt" DESC
    </select>

    <!-- 알림 읽음 상태 업데이트 -->
    <update id="updateNotificationReadStatus">
        UPDATE NOTIFICATION_LOG
        SET IS_READ = 'Y'
        WHERE NOTIFICATION_ID = #{notificationId}
          AND MEMBER_ID = #{memberId}
    </update>
    
    <!-- 알림 삭제 -->
	<delete id="deleteNotification">
	    DELETE FROM NOTIFICATION_LOG
	    WHERE NOTIFICATION_ID = #{notificationId}
	      AND MEMBER_ID = #{memberId}
	</delete>

    <!-- 읽지 않은 알림 개수 조회 -->
    <select id="selectUnreadNotificationCount" resultType="int">
        SELECT COUNT(*)
        FROM NOTIFICATION_LOG
        WHERE MEMBER_ID = #{memberId}
          AND IS_READ = 'N'
    </select>

    <!-- 안전 알림 설정 조회 -->
    <select id="selectSafetyAlertSettings" resultType="map">
        SELECT 
            SETTING_ID AS "settingId",
            MEMBER_ID AS "memberId",
            NOTIFICATION_ENABLED AS "notificationEnabled"
        FROM SAFETY_ALERT_SETTINGS
        WHERE MEMBER_ID = #{memberId}
    </select>

    <!-- 기본 안전 알림 설정 생성 (알림 OFF) -->
    <insert id="insertDefaultSafetyAlertSettings">
        INSERT INTO SAFETY_ALERT_SETTINGS (
            SETTING_ID,
            MEMBER_ID,
            NOTIFICATION_ENABLED
        ) VALUES (
            SEQ_SAFETY_ALERT_SETTINGS.NEXTVAL,
            #{memberId},
            'N'
        )
    </insert>

    <!-- 안전 알림 설정 생성 -->
    <insert id="insertSafetyAlertSettings">
        INSERT INTO SAFETY_ALERT_SETTINGS (
            SETTING_ID,
            MEMBER_ID,
            NOTIFICATION_ENABLED
        ) VALUES (
            SEQ_SAFETY_ALERT_SETTINGS.NEXTVAL,
            #{memberId},
            #{notificationEnabled}
        )
    </insert>

    <!-- 안전 알림 설정 업데이트 -->
    <update id="updateSafetyAlertSettings">
        UPDATE SAFETY_ALERT_SETTINGS
        SET NOTIFICATION_ENABLED = #{notificationEnabled}
        WHERE MEMBER_ID = #{memberId}
    </update>

    <!-- 공표 정보 조회 -->
    <select id="selectSafetyAlertById" resultType="com.fom.boot.domain.alert.model.vo.SafetyAlert">
        SELECT 
            ALERT_ID AS alertId,
            INGREDIENT_ID AS ingredientId,
            NATION AS nation,
            HAZARD_TYPE AS hazardType,
            TITLE AS title,
            DESCRIPTION AS description,
            PUBLICATION_DATE AS publicationDate
        FROM SAFETY_ALERT_MASTER
        WHERE ALERT_ID = #{alertId}
    </select>

    <!-- 특정 식재료에 대해 알림 수신이 활성화된 회원 목록 조회 (개인화) -->
    <select id="selectMembersWithIngredientAlertEnabled" resultType="string">
        SELECT DISTINCT mia.MEMBER_ID
        FROM MEMBER_INGREDIENT_ALERT mia
        INNER JOIN SAFETY_ALERT_SETTINGS sas
            ON mia.MEMBER_ID = sas.MEMBER_ID
        WHERE mia.INGREDIENT_ID = #{ingredientId}
          AND sas.NOTIFICATION_ENABLED = 'Y'
    </select>

    <!-- 알림 로그 생성 -->
    <insert id="insertNotificationLog">
        INSERT INTO NOTIFICATION_LOG (
            NOTIFICATION_ID,
            MEMBER_ID,
            TYPE,
            MESSAGE,
            IS_READ,
            SENT_AT,
            ALERT_ID
        ) VALUES (
            SEQ_NOTIFICATION_LOG.NEXTVAL,
            #{memberId},
            #{type},
            #{message},
            'N',
            SYSTIMESTAMP,
            #{alertId, jdbcType=NUMERIC}
        )
    </insert>
    
    <!-- 키워드로 식재료 ID 찾기 (E. 미구현 문제 해결) -->
    <select id="findIngredientIdByKeyword" resultType="int">
        SELECT INGREDIENT_ID
        FROM INGREDIENT_MASTER
        WHERE #{keyword} LIKE '%' || NAME || '%'
        AND ROWNUM = 1
    </select>
    
    <!-- 안전 위험 공표 정보 배치 등록 (D. 배치 삽입 문제 해결) -->
    <insert id="insertBatchSafetyAlert"
            parameterType="java.util.List">
        INSERT INTO SAFETY_ALERT_MASTER (
            ALERT_ID,
            INGREDIENT_ID,
            NATION,
            HAZARD_TYPE,
            TITLE,
            DESCRIPTION,
            PUBLICATION_DATE,
            ORIGINAL_URL
        )
        SELECT
            SEQ_SAFETY_ALERT_MASTER.NEXTVAL,
            INGREDIENT_ID,
            NATION,
            HAZARD_TYPE,
            TITLE,
            DESCRIPTION,
            PUBLICATION_DATE,
            ORIGINAL_URL
        FROM (
            <foreach collection="list" item="alert" separator=" UNION ALL ">
            SELECT
                #{alert.ingredientId, jdbcType=NUMERIC} AS INGREDIENT_ID,
                #{alert.nation, jdbcType=VARCHAR} AS NATION,
                #{alert.hazardType, jdbcType=VARCHAR} AS HAZARD_TYPE,
                #{alert.title, jdbcType=VARCHAR} AS TITLE,
                #{alert.description, jdbcType=CLOB} AS DESCRIPTION,
                #{alert.publicationDate, jdbcType=TIMESTAMP} AS PUBLICATION_DATE,
                #{alert.originalUrl, jdbcType=VARCHAR} AS ORIGINAL_URL
            FROM DUAL
            </foreach>
        )
    </insert>
    
    <!-- 복합 키로 중복 체크 (C. 중복 체크 취약 문제 해결) -->
    <select id="countByComplexKey" resultType="int">
        SELECT COUNT(*)
        FROM SAFETY_ALERT_MASTER
        WHERE TITLE = #{title}
          AND NATION = #{nation}
          AND PUBLICATION_DATE = #{publicationDate, jdbcType=TIMESTAMP}
    </select>

    <!-- 복합 키로 Alert ID 조회 (배치 삽입 후 ID 조회용) -->
    <select id="findAlertIdByComplexKey" resultType="int">
        SELECT ALERT_ID
        FROM SAFETY_ALERT_MASTER
        WHERE TITLE = #{title}
          AND NATION = #{nation}
          AND PUBLICATION_DATE = #{publicationDate, jdbcType=TIMESTAMP}
          AND ROWNUM = 1
    </select>

    <!-- 회원의 특정 식재료 알림 설정 확인 -->
    <select id="countIngredientAlert" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER_INGREDIENT_ALERT
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </select>

    <!-- 특정 식재료 알림 등록 -->
    <insert id="insertIngredientAlert">
        INSERT INTO MEMBER_INGREDIENT_ALERT (
            MEMBER_ID,
            INGREDIENT_ID
        ) VALUES (
            #{memberId},
            #{ingredientId}
        )
    </insert>

    <!-- 특정 식재료 알림 해제 -->
    <delete id="deleteIngredientAlert">
        DELETE FROM MEMBER_INGREDIENT_ALERT
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </delete>

    <!-- 알림이 설정된 모든 고유 식재료 ID 조회 -->
    <select id="selectAllAlertIngredientIds" resultType="int">
        SELECT DISTINCT INGREDIENT_ID
        FROM MEMBER_INGREDIENT_ALERT
        ORDER BY INGREDIENT_ID
    </select>
    
    <!-- 마이페이지: 알림내역수 조회 -->
    <select id="selectUserSafetyNotiCount" resultType="int">
    SELECT COUNT(*)
    FROM NOTIFICATION_LOG nl
	    LEFT JOIN SAFETY_ALERT_MASTER sam
	        ON nl.ALERT_ID = sam.ALERT_ID
	    WHERE nl.MEMBER_ID = #{memberId}
	      AND nl.TYPE = '위험공표'
	      
	    <if test="readStatus != null and readStatus != 'all'">
            AND nl.IS_READ = #{readStatus}
       	</if>
	    
	    <!-- 검색 -->
	    <if test="keyword != null and keyword != ''">
	        AND (
	            nl.MESSAGE LIKE '%' || #{keyword} || '%'
	            OR sam.TITLE LIKE '%' || #{keyword} || '%'
	            OR sam.NATION LIKE '%' || #{keyword} || '%'
	            OR sam.HAZARD_TYPE LIKE '%' || #{keyword} || '%'
	        )
	    </if>
	</select>

	<!-- 마이페이지: 알림내역목록 조회 -->
    <select id="selectUserSafetyNotiList" resultType="map">
	SELECT * FROM (
	    SELECT 
	        ROW_NUMBER() OVER (
	            ORDER BY
	            <choose>
	                <!-- 지원하는 정렬 컬럼 -->
	                <when test="sortColumn == 'sentAt'">nl.SENT_AT</when>
	                <when test="sortColumn == 'title'">sam.TITLE</when>
	                <when test="sortColumn == 'nation'">sam.NATION</when>
	                <when test="sortColumn == 'hazardType'">sam.HAZARD_TYPE</when>
	                <when test="sortColumn == 'alertId'">nl.ALERT_ID</when>
	
	                <!-- 기본값: 최신 알림 먼저 -->
	                <otherwise>nl.SENT_AT</otherwise>
	            </choose>
	            
	            <choose>
	                <when test="sortOrder == 'asc'">ASC</when>
	                <otherwise>DESC</otherwise>
	            </choose>
	        ) AS rn,
	        
	        nl.NOTIFICATION_ID AS "notificationId",
	        nl.MEMBER_ID AS "memberId",
	        nl.IS_READ AS "isRead",
	        TO_CHAR(nl.SENT_AT, 'YYYY-MM-DD"T"HH24:MI:SS') AS "sentAt",
	        
	        nl.MESSAGE AS "message",
	        nl.ALERT_ID AS "alertId",
	        
	        sam.TITLE AS "title",
	        sam.NATION AS "nation",
	        sam.HAZARD_TYPE AS "hazardType",
	        TO_CHAR(sam.PUBLICATION_DATE, 'YYYY-MM-DD"T"HH24:MI:SS') AS "publicationDate",
	        sam.ORIGINAL_URL AS "originalUrl"
	
	    FROM NOTIFICATION_LOG nl
	    LEFT JOIN SAFETY_ALERT_MASTER sam
	        ON nl.ALERT_ID = sam.ALERT_ID
	    
	    WHERE nl.MEMBER_ID = #{memberId}
	      AND nl.TYPE = '위험공표'
	      
	    <if test="readStatus != null and readStatus != 'all'">
            AND nl.IS_READ = #{readStatus}
        </if>
	    
	    <!-- 검색 -->
	    <if test="keyword != null and keyword != ''">
	        AND (
	            nl.MESSAGE LIKE '%' || #{keyword} || '%'
	            OR sam.TITLE LIKE '%' || #{keyword} || '%'
	            OR sam.NATION LIKE '%' || #{keyword} || '%'
	            OR sam.HAZARD_TYPE LIKE '%' || #{keyword} || '%'
	        )
	    </if>
	
	) WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
    <!-- 모든 읽지 않은 알림 읽음 처리 -->
	<update id="updateAllNotificationsReadStatus">
	    UPDATE NOTIFICATION_LOG
	    SET IS_READ = 'Y'
	    WHERE MEMBER_ID = #{memberId}
	      AND IS_READ = 'N'
	</update>
	
	<!-- 특정 유형 읽지 않은 알림 읽음 처리 -->
	<update id="updateAllNotificationsReadStatusByType">
	    UPDATE NOTIFICATION_LOG
	    SET IS_READ = 'Y'
	    WHERE MEMBER_ID = #{memberId}
	      AND TYPE = #{type}
	      AND IS_READ = 'N'
	</update>

	<!-- 마이페이지: 가격 알림 내역 개수 조회 -->
	<select id="selectUserPriceNotiCount" resultType="int">
	    SELECT COUNT(*)
	    FROM NOTIFICATION_LOG nl
	    WHERE nl.MEMBER_ID = #{memberId}
	      AND nl.TYPE IN ('가격정보', '가격변동')
	    <if test="readStatus != null and readStatus != 'all'">
	        AND nl.IS_READ = #{readStatus}
	    </if>
	    <if test="keyword != null and keyword != ''">
	        AND nl.MESSAGE LIKE '%' || #{keyword} || '%'
	    </if>
	</select>

	<!-- 마이페이지: 가격 알림 내역 목록 조회 -->
	<select id="selectUserPriceNotiList" resultType="map">
	    SELECT * FROM (
	        SELECT
	            ROW_NUMBER() OVER (
	                ORDER BY
	                <choose>
	                    <when test="sortColumn == 'sentAt'">nl.SENT_AT</when>
	                    <otherwise>nl.SENT_AT</otherwise>
	                </choose>
	                <choose>
	                    <when test="sortOrder == 'asc'">ASC</when>
	                    <otherwise>DESC</otherwise>
	                </choose>
	            ) AS rn,
	            nl.NOTIFICATION_ID AS "notificationId",
	            nl.MEMBER_ID AS "memberId",
	            nl.TYPE AS "type",
	            nl.MESSAGE AS "message",
	            nl.IS_READ AS "isRead",
	            TO_CHAR(nl.SENT_AT, 'YYYY-MM-DD"T"HH24:MI:SS') AS "sentAt",
	            CASE
	                WHEN nl.MESSAGE LIKE '%||%' THEN
	                    TO_NUMBER(SUBSTR(nl.MESSAGE, INSTR(nl.MESSAGE, '||') + 2))
	                ELSE NULL
	            END AS "ingredientId"
	        FROM NOTIFICATION_LOG nl
	        WHERE nl.MEMBER_ID = #{memberId}
	          AND nl.TYPE IN ('가격정보', '가격변동')
	        <if test="readStatus != null and readStatus != 'all'">
	            AND nl.IS_READ = #{readStatus}
	        </if>
	        <if test="keyword != null and keyword != ''">
	            AND nl.MESSAGE LIKE '%' || #{keyword} || '%'
	        </if>
	    ) WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>

  </mapper>