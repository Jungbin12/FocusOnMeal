<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.alert.model.mapper.AlertMapper">
  
      <!-- 회원의 알림 목록 조회 (제목 포함) -->
    <select id="selectNotificationsByMemberId" resultType="map">
        SELECT 
            nl.NOTIFICATION_ID AS "notificationId",
            nl.MEMBER_ID AS "memberId",
            nl.TYPE AS "type",
            nl.MESSAGE AS "message",
            nl.IS_READ AS "isRead",
            TO_CHAR(nl.SENT_AT, 'YYYY-MM-DD"T"HH24:MI:SS') AS "sentAt",
            NVL(sam.TITLE, '알림') AS "title"
        FROM NOTIFICATION_LOG nl
        LEFT JOIN SAFETY_ALERT_MASTER sam 
            ON nl.TYPE = '위험공표' 
            AND sam.ALERT_ID = (
                SELECT MAX(ALERT_ID) 
                FROM SAFETY_ALERT_MASTER 
                WHERE TITLE = SUBSTR(nl.MESSAGE, 1, 50)
            )
        WHERE nl.MEMBER_ID = #{memberId}
        ORDER BY nl.SENT_AT DESC
    </select>

    <!-- 알림 읽음 상태 업데이트 -->
    <update id="updateNotificationReadStatus">
        UPDATE NOTIFICATION_LOG
        SET IS_READ = 'Y'
        WHERE NOTIFICATION_ID = #{notificationId}
          AND MEMBER_ID = #{memberId}
    </update>

    <!-- 읽지 않은 알림 개수 조회 -->
    <select id="selectUnreadNotificationCount" resultType="int">
        SELECT COUNT(*)
        FROM NOTIFICATION_LOG
        WHERE MEMBER_ID = #{memberId}
          AND IS_READ = 'N'
    </select>

    <!-- 안전 알림 설정 조회 -->
    <select id="selectSafetyAlertSettings" resultType="map">
        SELECT 
            SETTING_ID AS settingId,
            MEMBER_ID AS memberId,
            NOTIFICATION_ENABLED AS notificationEnabled
        FROM SAFETY_ALERT_SETTINGS
        WHERE MEMBER_ID = #{memberId}
    </select>

    <!-- 기본 안전 알림 설정 생성 (알림 OFF) -->
    <insert id="insertDefaultSafetyAlertSettings">
        INSERT INTO SAFETY_ALERT_SETTINGS (
            SETTING_ID,
            MEMBER_ID,
            NOTIFICATION_ENABLED
        ) VALUES (
            SEQ_SAFETY_ALERT_SETTINGS.NEXTVAL,
            #{memberId},
            'N'
        )
    </insert>

    <!-- 안전 알림 설정 생성 -->
    <insert id="insertSafetyAlertSettings">
        INSERT INTO SAFETY_ALERT_SETTINGS (
            SETTING_ID,
            MEMBER_ID,
            NOTIFICATION_ENABLED
        ) VALUES (
            SEQ_SAFETY_ALERT_SETTINGS.NEXTVAL,
            #{memberId},
            #{notificationEnabled}
        )
    </insert>

    <!-- 안전 알림 설정 업데이트 -->
    <update id="updateSafetyAlertSettings">
        UPDATE SAFETY_ALERT_SETTINGS
        SET NOTIFICATION_ENABLED = #{notificationEnabled}
        WHERE MEMBER_ID = #{memberId}
    </update>

    <!-- 공표 정보 조회 -->
    <select id="selectSafetyAlertById" resultType="com.fom.boot.domain.alert.model.vo.SafetyAlert">
        SELECT 
            ALERT_ID AS alertId,
            INGREDIENT_ID AS ingredientId,
            NATION AS nation,
            HAZARD_TYPE AS hazardType,
            TITLE AS title,
            DESCRIPTION AS description,
            PUBLICATION_DATE AS publicationDate
        FROM SAFETY_ALERT_MASTER
        WHERE ALERT_ID = #{alertId}
    </select>

    <!-- 특정 식재료에 대해 알림 수신이 활성화된 회원 목록 조회 (개인화) -->
    <select id="selectMembersWithIngredientAlertEnabled" resultType="string">
        SELECT MEMBER_ID
        FROM SAFETY_ALERT_SETTINGS
        WHERE NOTIFICATION_ENABLED = 'Y'
    </select>

    <!-- 알림 로그 생성 -->
    <insert id="insertNotificationLog">
        INSERT INTO NOTIFICATION_LOG (
            NOTIFICATION_ID,
            MEMBER_ID,
            TYPE,
            MESSAGE,
            IS_READ,
            SENT_AT
        ) VALUES (
            SEQ_NOTIFICATION_LOG.NEXTVAL,
            #{memberId},
            #{type},
            #{message},
            'N',
            SYSTIMESTAMP
        )
    </insert>
    
    <!-- 키워드로 식재료 ID 찾기 (E. 미구현 문제 해결) -->
    <select id="findIngredientIdByKeyword" resultType="int">
        SELECT INGREDIENT_ID
        FROM INGREDIENT_MASTER
        WHERE NAME LIKE '%' || #{keyword} || '%' 
        AND ROWNUM = 1
    </select>
    
    <!-- 안전 위험 공표 정보 배치 등록 (D. 배치 삽입 문제 해결) -->
    <insert id="insertBatchSafetyAlert" 
            parameterType="java.util.List">
        INSERT ALL
        <foreach collection="list" item="alert" separator=" ">
        INTO SAFETY_ALERT_MASTER (
            ALERT_ID,
            INGREDIENT_ID,
            NATION,
            HAZARD_TYPE,
            TITLE,
            DESCRIPTION,
            PUBLICATION_DATE,
            ORIGINAL_URL
        ) VALUES (
            SEQ_SAFETY_ALERT_MASTER.NEXTVAL,
            #{alert.ingredientId},
            #{alert.nation},
            #{alert.hazardType},
            #{alert.title},
            #{alert.description},
            #{alert.publicationDate, jdbcType=TIMESTAMP},
            #{alert.originalUrl}
        )
        </foreach>
        SELECT * FROM DUAL
    </insert>
    
    <!-- 복합 키로 중복 체크 (C. 중복 체크 취약 문제 해결) -->
    <select id="countByComplexKey" resultType="int">
        SELECT COUNT(*)
        FROM SAFETY_ALERT_MASTER
        WHERE TITLE = #{title}
          AND NATION = #{nation}
          AND PUBLICATION_DATE = #{publicationDate, jdbcType=TIMESTAMP}
    </select>
  
  </mapper>