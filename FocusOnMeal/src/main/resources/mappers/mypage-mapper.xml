<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.fom.boot.domain.mypage.model.mapper.MyPageMapper">
  
	  <update id="logicalDeleteMealPlan">
	      UPDATE MEAL_PLAN
	      SET IS_DELETED = 'Y',
	          DELETED_AT = SYSTIMESTAMP
	      WHERE PLAN_ID = #{planId}
	  </update>
	  
	  <!-- 대시보드 -->
	  <select id="getMemberInfo" resultType="com.fom.boot.domain.member.model.vo.Member">
	    	SELECT MEMBER_ID, MEMBER_NAME, EMAIL, MEMBER_NICKNAME
		    FROM MEMBER
		    WHERE MEMBER_ID = #{memberId}
	  </select>
	  <select id="getFavoriteIngredientCount" resultType="int">
		    SELECT COUNT(*) FROM FAVORITE
		    WHERE MEMBER_ID = #{memberId}
	  </select>
	  <select id="getFavoriteMealCount" resultType="int">
		    SELECT COUNT(*) FROM MEAL_PLAN
		    WHERE MEMBER_ID = #{memberId}
		    ORDER BY CREATED_AT DESC
	  </select>
	  <select id="getRecentMeals" resultType="com.fom.boot.domain.meal.model.vo.MealPlan">
		    SELECT PLAN_ID, PLAN_NAME, CREATED_AT
		    FROM MEAL_PLAN
		    WHERE MEMBER_ID = #{memberId}
		    ORDER BY CREATED_AT DESC
		    FETCH FIRST 5 ROWS ONLY
	  </select>
	  
	<!-- 대시보드2 -->
	<!-- 찜한 식자재 요약 목록 조회 (최신 가격 포함) -->
    <select id="findFavoriteIngredientSummary" resultType="FavoriteIngredientSummaryDTO">
        SELECT 
            f.FAVORITE_ID AS favoriteId,
            f.INGREDIENT_ID AS ingredientId,
            im.NAME AS name,
            f.IS_CUSTOM AS isCustom,
            im.STANDARD_UNIT AS standardUnit,
            (
                SELECT ph.PRICE_VALUE
                FROM PRICE_HISTORY ph
                WHERE ph.INGREDIENT_ID = f.INGREDIENT_ID
                ORDER BY ph.COLLECTED_DATE DESC
                FETCH FIRST 1 ROW ONLY
            ) AS currentPrice
        FROM FAVORITE f
        JOIN INGREDIENT_MASTER im ON f.INGREDIENT_ID = im.INGREDIENT_ID
        WHERE f.MEMBER_ID = #{memberId}
        ORDER BY f.FAVORITE_ID DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>
    <!-- 찜한 식자재 총 개수 -->
    <select id="countFavoriteIngredients" resultType="int">
        SELECT COUNT(*)
        FROM FAVORITE
        WHERE MEMBER_ID = #{memberId}
    </select>
    <!-- 식단 요약 목록 조회 -->
    <select id="findMealPlanSummary" resultType="MealPlanSummaryDTO">
        SELECT 
            PLAN_ID AS planId,
            PLAN_NAME AS planName,
            TOTAL_COST AS totalCost,
            SERVING_SIZE AS servingSize
        FROM MEAL_PLAN
        WHERE MEMBER_ID = #{memberId}
          AND (IS_DELETED IS NULL OR IS_DELETED = 'N')
        ORDER BY CREATED_AT DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>
    <!-- 식단 총 개수 -->
    <select id="countMealPlans" resultType="int">
        SELECT COUNT(*)
        FROM MEAL_PLAN
        WHERE MEMBER_ID = #{memberId}
          AND (IS_DELETED IS NULL OR IS_DELETED = 'N')
    </select>
    
    
  </mapper>