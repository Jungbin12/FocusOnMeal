<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fom.boot.domain.mypage.model.mapper.MyPageMapper">

    <update id="logicalDeleteMealPlan">
         UPDATE MEAL_PLAN
         SET IS_DELETED = 'Y',
             DELETED_AT = SYSTIMESTAMP
         WHERE PLAN_ID = #{planId}
     </update>
     
     <!-- 대시보드 -->
     <select id="getMemberInfo" resultType="com.fom.boot.domain.member.model.vo.Member">
          SELECT MEMBER_ID, MEMBER_NAME, EMAIL, MEMBER_NICKNAME
          FROM MEMBER
          WHERE MEMBER_ID = #{memberId}
     </select>
     <select id="getFavoriteIngredientCount" resultType="int">
          SELECT COUNT(*) FROM FAVORITE
          WHERE MEMBER_ID = #{memberId}
     </select>
     <select id="getFavoriteMealCount" resultType="int">
          SELECT COUNT(*) FROM MEAL_PLAN
          WHERE MEMBER_ID = #{memberId}
          ORDER BY CREATED_AT DESC
     </select>
     <select id="getRecentMeals" resultType="com.fom.boot.domain.meal.model.vo.MealPlan">
          SELECT PLAN_ID, PLAN_NAME, CREATED_AT
          FROM MEAL_PLAN
          WHERE MEMBER_ID = #{memberId}
          ORDER BY CREATED_AT DESC
          FETCH FIRST 5 ROWS ONLY
     </select>
     
   <!-- 대시보드2 -->
   <select id="findMemberInfo" resultType="com.fom.boot.domain.member.model.vo.Member">
       SELECT MEMBER_ID, MEMBER_NAME, EMAIL, MEMBER_NICKNAME
       FROM MEMBER
       WHERE MEMBER_ID = #{memberId}
   </select>
   <!-- 찜한 식자재 요약 목록 조회 (최신 가격 포함) -->
    <select id="findFavoriteIngredientSummary" resultType="FavoriteIngredientSummaryDTO">
        SELECT 
            f.FAVORITE_ID AS favoriteId,
            f.INGREDIENT_ID AS ingredientId,
            im.NAME AS ingredientName,
            f.IS_CUSTOM AS isCustom,
            im.STANDARD_UNIT AS standardUnit,
            (
                SELECT ph.PRICE_VALUE
                FROM PRICE_HISTORY ph
                WHERE ph.INGREDIENT_ID = f.INGREDIENT_ID
                ORDER BY ph.COLLECTED_DATE DESC
                FETCH FIRST 1 ROW ONLY
            ) AS currentPrice
        FROM FAVORITE f
        JOIN INGREDIENT_MASTER im ON f.INGREDIENT_ID = im.INGREDIENT_ID
        WHERE f.MEMBER_ID = #{memberId}
        ORDER BY f.FAVORITE_ID DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>
    <!-- 찜한 식자재 총 개수 -->
    <select id="countFavoriteIngredients" resultType="int">
        SELECT COUNT(*)
        FROM FAVORITE
        WHERE MEMBER_ID = #{memberId}
    </select>
    <!-- 식단 요약 목록 조회 -->
    <select id="findMealPlanSummary" resultType="MealPlanSummaryDTO">
        SELECT
            PLAN_ID AS planId,
            PLAN_NAME AS planName,
            TOTAL_COST AS totalCost,
            SERVING_SIZE AS servingSize
        FROM MEAL_PLAN
        WHERE MEMBER_ID = #{memberId}
          AND (IS_DELETED IS NULL OR IS_DELETED = 'N')
        ORDER BY CREATED_AT DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>
    <!-- 식단 총 개수 -->
    <select id="countMealPlans" resultType="int">
        SELECT COUNT(*)
        FROM MEAL_PLAN
        WHERE MEMBER_ID = #{memberId}
          AND (IS_DELETED IS NULL OR IS_DELETED = 'N')
    </select>

    <!-- ====== 알레르기 기능 ====== -->


    <!-- ✅ resultType을 Allergy로 지정 (리스트는 자동 처리) -->
	<select id="getAllAllergies" resultType="com.fom.boot.app.mypage.dto.Allergy">
	    SELECT 
	        ALLERGY_ID AS allergyId,
	        ALLERGY_NAME AS allergyName,
	        CATEGORY AS category
	    FROM ALLERGY_MASTER
	    ORDER BY ALLERGY_ID
	</select>

    <!-- 특정 회원의 알레르기 ID 조회 -->
    <select id="getUserAllergyIds" parameterType="string" resultType="int">
        SELECT ALLERGY_ID
        FROM MEMBER_ALLERGY
        WHERE MEMBER_ID = #{memberId}
    </select>

    <!-- 기존 알레르기 삭제 -->
    <delete id="deleteUserAllergies" parameterType="string">
        DELETE FROM MEMBER_ALLERGY
        WHERE MEMBER_ID = #{memberId}
    </delete>

    <!-- 알레르기 하나씩 insert -->
    <insert id="insertUserAllergy">
        INSERT INTO MEMBER_ALLERGY (MEMBER_ID, ALLERGY_ID)
        VALUES (#{memberId}, #{allergyId})
    </insert>

    <!-- ====== 내 식단 페이지 ====== -->

    <!-- 내 식단 목록 조회 (페이지네이션) -->
    <select id="selectMyMealPlans" resultType="com.fom.boot.domain.meal.model.vo.MealPlan">
        SELECT *
        FROM (
            SELECT
                PLAN_ID as planId,
                MEMBER_ID as memberId,
                PLAN_NAME as planName,
                SERVING_SIZE as servingSize,
                TOTAL_COST as totalCost,
                CALORIES as calories,
                CARBS_G as carbsG,
                PROTEIN_G as proteinG,
                FAT_G as fatG,
                AI_RECIPE as aiRecipe,
                WHEN_EAT as whenEat,
                CREATED_AT as createdAt,
                IS_DELETED as isDelete,
                DELETED_AT as deleteAt,
                INGREDIENTS_JSON as ingredientsJson,
                ROW_NUMBER() OVER (ORDER BY CREATED_AT DESC) AS rnum
            FROM MEAL_PLAN
            WHERE MEMBER_ID = #{memberId}
              AND (IS_DELETED IS NULL OR IS_DELETED = 'N')
        )
        WHERE rnum BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- 식단 상세 조회 -->
    <select id="selectMealPlanById" resultType="com.fom.boot.domain.meal.model.vo.MealPlan">
        SELECT
            PLAN_ID as planId,
            MEMBER_ID as memberId,
            PLAN_NAME as planName,
            SERVING_SIZE as servingSize,
            TOTAL_COST as totalCost,
            CALORIES as calories,
            CARBS_G as carbsG,
            PROTEIN_G as proteinG,
            FAT_G as fatG,
            AI_RECIPE as aiRecipe,
            WHEN_EAT as whenEat,
            CREATED_AT as createdAt,
            IS_DELETED as isDelete,
            DELETED_AT as deleteAt,
            INGREDIENTS_JSON as ingredientsJson
        FROM MEAL_PLAN
        WHERE PLAN_ID = #{planId}
          AND (IS_DELETED IS NULL OR IS_DELETED = 'N')
    </select>

    <!-- ====== 휴지통 기능 ====== -->

    <!-- 삭제된 식단 목록 조회 -->
    <select id="selectDeletedMealPlans" resultType="com.fom.boot.domain.meal.model.vo.MealPlan">
        SELECT
            PLAN_ID as planId,
            MEMBER_ID as memberId,
            PLAN_NAME as planName,
            SERVING_SIZE as servingSize,
            TOTAL_COST as totalCost,
            CALORIES as calories,
            WHEN_EAT as whenEat,
            CREATED_AT as createdAt,
            DELETED_AT as deleteAt
        FROM MEAL_PLAN
        WHERE MEMBER_ID = #{memberId}
          AND IS_DELETED = 'Y'
        ORDER BY DELETED_AT DESC
    </select>

    <!-- 삭제된 식단 개수 -->
    <select id="countDeletedMealPlans" resultType="int">
        SELECT COUNT(*)
        FROM MEAL_PLAN
        WHERE MEMBER_ID = #{memberId}
          AND IS_DELETED = 'Y'
    </select>

    <!-- 식단 복원 -->
    <update id="restoreMealPlan">
        UPDATE MEAL_PLAN
        SET IS_DELETED = 'N',
            DELETED_AT = NULL
        WHERE PLAN_ID = #{planId}
    </update>

    <!-- 식단 영구 삭제 -->
    <delete id="permanentDeleteMealPlan">
        DELETE FROM MEAL_PLAN
        WHERE PLAN_ID = #{planId}
    </delete>

    <!-- 휴지통 비우기 (일괄 영구 삭제) -->
    <delete id="permanentDeleteAllDeletedMeals">
        DELETE FROM MEAL_PLAN
        WHERE MEMBER_ID = #{memberId}
          AND IS_DELETED = 'Y'
    </delete>

    <!-- 30일 경과 식단 자동 영구 삭제 -->
    <delete id="permanentDeleteExpiredMeals">
        DELETE FROM MEAL_PLAN
        WHERE IS_DELETED = 'Y'
          AND DELETED_AT &lt; SYSTIMESTAMP - INTERVAL '30' DAY
    </delete>

</mapper>
